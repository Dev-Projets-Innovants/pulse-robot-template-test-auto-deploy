

name: Deploy Application (Vite React TS)

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# DÃ©clencheurs
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
on:
  push:
    branches: [main, development_test]
  workflow_dispatch:
    inputs:
      environment:
        description: "Environment to deploy to"
        required: true
        default: dev
        type: choice
        options: [dev, prod]

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Job unique
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
jobs:
  deploy:
    runs-on: windows-latest

    # Environnement GitHub ciblÃ© : production ou development-test
    environment: ${{ github.ref == 'refs/heads/main' && 'production' || 'development-test' }}

    # Variables/Secrets injectÃ©s pour toutes les steps
    env:
      # Variables communes
      SUPABASE_PROJECT_REF:     ${{ vars.SUPABASE_PROJECT_REF }}
      SUPABASE_URL:             ${{ vars.SUPABASE_URL }}

      # Secrets
      SUPABASE_ANON_KEY:        ${{ secrets.SUPABASE_ANON_KEY }}
      SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
      SUPABASE_DB_PASSWORD:     ${{ secrets.SUPABASE_DB_PASSWORD }}
      SUPABASE_ACCESS_TOKEN:    ${{ secrets.SUPABASE_ACCESS_TOKEN }}

      # ExposÃ©es au front Vite
      VITE_SUPABASE_URL:        ${{ vars.SUPABASE_URL }}
      VITE_SUPABASE_ANON_KEY:   ${{ secrets.SUPABASE_ANON_KEY }}

      # Pour la simulation FTP
      DEPLOY_ENV: ${{ github.ref == 'refs/heads/main' && 'prod' || 'dev' }}

    steps:
    # 1) Checkout
    - uses: actions/checkout@v4

    # 2) Node 18 + cache npm
    - uses: actions/setup-node@v4
      with:
        node-version: 18
        cache: npm

    # 3) Installe la CLI Supabase
    - uses: supabase/setup-cli@v1
      with:
        version: latest

    # 4) Lier le projet Supabase (mot de passe = DB_PASSWORD)
    - name: Link Supabase project
      shell: pwsh
      env:
        SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
      run: |
        Write-Host "ğŸ”— Linking project $env:SUPABASE_PROJECT_REF"
        supabase link --project-ref $env:SUPABASE_PROJECT_REF --password $env:SUPABASE_DB_PASSWORD

    # 5) Appliquer ou rÃ©parer les migrations
    - name: ğŸ“¦ Apply or repair migrations
      shell: pwsh
      env:
        SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
      run: |
        Write-Host "ğŸ“¦ Applying migrations..."
        supabase db push
        if ($LASTEXITCODE -ne 0) {
          Write-Warning "âš ï¸ Migration mismatch detected, running autoâ€‘repair..."
          
          # Ã‰tape 1 : pull le schÃ©ma actuel pour se synchroniser
          supabase db pull

          # Ã‰tape 2 : lecture des versions distantes non prÃ©sentes localement
          $output = supabase migration list --format json | ConvertFrom-Json
          $remoteOnly = $output.versions | Where-Object { $_.source -eq "remote" -and $_.status -eq "applied" }

          if ($remoteOnly.Count -eq 0) {
            Write-Error "âŒ Aucun ID distant Ã  rÃ©parer trouvÃ©."
            exit 1
          }

          # Ã‰tape 3 : marquer chaque version distante comme "applied"
          foreach ($migration in $remoteOnly) {
            $version = $migration.version
            Write-Host "ğŸ”§ Repairing version $version"
            supabase migration repair --status applied $version
            if ($LASTEXITCODE -ne 0) {
              Write-Error "âŒ Ã‰chec du repair de $version"
              exit 1
            }
          }

          # Ã‰tape 4 : retenter le push
          supabase db push
          if ($LASTEXITCODE -ne 0) {
            Write-Error "âŒ Push Ã©chouÃ© mÃªme aprÃ¨s repair."
            exit 1
          } else {
            Write-Host "âœ… Migrations rÃ©parÃ©es et appliquÃ©es avec succÃ¨s."
          }
        } else {
          Write-Host "âœ… Migrations appliquÃ©es sans erreur."
        }

    # 6) Build Vite (dist/)
    - name: Build application
      run: |
        npm ci
        npm run build

    # 7) Simulation de dÃ©ploiement FTP
    - name: Run deployment simulation
      shell: pwsh
      run: ./scripts/simulate-ftp-deploy.ps1 -EnvName "$env:DEPLOY_ENV"

    # 8) Message final
    - name: Deployment complete
      shell: pwsh
      run: |
        Write-Host "ğŸ‰ Deployment to $env:DEPLOY_ENV completed!"
        Write-Host "ğŸ“ Files copied to C:\DeploySimulation\$env:DEPLOY_ENV"

